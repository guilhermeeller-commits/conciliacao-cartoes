<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliacao Bancaria — Calisul</title>
    <link rel="stylesheet" href="/css/design-system.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="/js/theme-toggle.js"></script>
    <script src="/js/sidebar.js"></script>
    <script src="/js/filtro-universal.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: #1a1f35;
            --bg-card-hover: #222842;
            --border: #2a3050;
            --text-primary: #f0f2f8;
            --text-secondary: #8891ab;
            --text-muted: #5a6380;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-orange: #f59e0b;
            --accent-cyan: #06b6d4;
            --gradient-blue: linear-gradient(135deg, #3b82f6, #6366f1);
            --gradient-green: linear-gradient(135deg, #10b981, #06b6d4);
            --gradient-red: linear-gradient(135deg, #ef4444, #ec4899);
            --gradient-purple: linear-gradient(135deg, #8b5cf6, #a855f7);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 20%, rgba(59, 130, 246, .04), transparent 50%), radial-gradient(circle at 70% 80%, rgba(139, 92, 246, .04), transparent 50%);
            z-index: 0;
            pointer-events: none;
        }

        /* ─── Layout ─── */
        .app {
            position: relative;
            z-index: 1;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        @media(min-width:768px) {
            .app {
                padding: 0;
            }
        }

        /* ─── Header ─── */
        .header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .header .back {
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            transition: .2s;
        }

        .header .back:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header h1 span {
            background: var(--gradient-blue);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ─── Cards Grid ─── */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .card.blue::before {
            background: var(--gradient-blue);
        }

        .card.green::before {
            background: var(--gradient-green);
        }

        .card.red::before {
            background: var(--gradient-red);
        }

        .card.purple::before {
            background: var(--gradient-purple);
        }

        .card .label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .card .value {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .card .sub {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* ─── Upload Zone ─── */
        .upload-section {
            margin-bottom: 32px;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: .3s;
            background: var(--bg-card);
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, .05);
        }

        .upload-zone .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-zone h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .upload-zone p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .upload-zone input {
            display: none;
        }

        .upload-zone.processing {
            pointer-events: none;
            opacity: .7;
        }

        /* ─── Progress Bar ─── */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width .5s ease;
        }

        .progress-fill.green {
            background: var(--gradient-green);
        }

        .progress-fill.blue {
            background: var(--gradient-blue);
        }

        /* ─── Sections ─── */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .section-header .badge {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-blue {
            background: rgba(59, 130, 246, .15);
            color: var(--accent-blue);
        }

        .badge-green {
            background: rgba(16, 185, 129, .15);
            color: var(--accent-green);
        }

        .badge-red {
            background: rgba(239, 68, 68, .15);
            color: var(--accent-red);
        }

        .badge-orange {
            background: rgba(245, 158, 11, .15);
            color: var(--accent-orange);
        }

        /* ─── Table ─── */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 10px 12px;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .5px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(42, 48, 80, .4);
            vertical-align: middle;
        }

        tr:hover td {
            background: rgba(59, 130, 246, .03);
        }

        .tipo-C {
            color: var(--accent-green);
            font-weight: 600;
        }

        .tipo-D {
            color: var(--accent-red);
            font-weight: 600;
        }

        .cat-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cat-auto {
            background: rgba(16, 185, 129, .12);
            color: var(--accent-green);
        }

        .cat-manual {
            background: rgba(245, 158, 11, .12);
            color: var(--accent-orange);
            cursor: pointer;
        }

        .cat-pending {
            background: rgba(239, 68, 68, .12);
            color: var(--accent-red);
            cursor: pointer;
        }

        /* ─── Buttons ─── */
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            border: none;
            cursor: pointer;
            transition: .2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-blue);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, .3);
        }

        .btn-success {
            background: var(--gradient-green);
            color: #fff;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-outline:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 12px;
            border-radius: 8px;
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        /* ─── Modal ─── */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .modal .desc-preview {
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            word-break: break-all;
        }

        .modal .cat-search {
            width: 100%;
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            outline: none;
            margin-bottom: 12px;
        }

        .modal .cat-search:focus {
            border-color: var(--accent-blue);
        }

        .modal .cat-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .modal .cat-item {
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: .15s;
            border: 1px solid transparent;
        }

        .modal .cat-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--border);
        }

        .modal .cat-item.selected {
            background: rgba(59, 130, 246, .1);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            justify-content: flex-end;
        }

        /* ─── Preview Result ─── */
        .preview-result {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 20px;
            margin-top: 16px;
        }

        .preview-result .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .preview-result .stat {
            text-align: center;
        }

        .preview-result .stat .num {
            font-size: 24px;
            font-weight: 800;
        }

        .preview-result .stat .lbl {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* ─── Toast ─── */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: .3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* ─── Extratos List ─── */
        .extrato-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px;
            border-radius: 12px;
            background: var(--bg-secondary);
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .extrato-item .banco-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .extrato-item .info {
            flex: 1;
            min-width: 150px;
        }

        .extrato-item .info h4 {
            font-size: 14px;
            font-weight: 600;
        }

        .extrato-item .info p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .extrato-item .stats-mini {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .extrato-item .stats-mini span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ─── Responsive ─── */
        @media(max-width:600px) {
            .header h1 {
                font-size: 20px;
            }

            .card .value {
                font-size: 22px;
            }

            .upload-zone {
                padding: 24px 16px;
            }

            .upload-zone .icon {
                font-size: 36px;
            }

            .section {
                padding: 16px;
            }

            td,
            th {
                padding: 8px 6px;
                font-size: 12px;
            }
        }

        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, .3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin .6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none !important;
        }

        /* ─── Sortable Headers ─── */
        th.sortable {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            transition: color 0.15s;
        }

        th.sortable:hover {
            color: var(--accent-blue);
        }

        th.sortable .sort-arrow {
            margin-left: 3px;
            font-size: 10px;
            opacity: 0.4;
        }

        th.sortable.sort-active .sort-arrow {
            opacity: 1;
            color: var(--accent-blue);
        }

        /* ─── Batch Actions Bar ─── */
        .batch-bar {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.12));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 14px;
            margin-top: 12px;
            animation: batchSlideIn 0.25s ease;
            flex-wrap: wrap;
        }

        @keyframes batchSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .batch-counter {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .batch-cat-select {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
            max-width: 220px;
        }

        .batch-cat-select:focus {
            border-color: var(--accent-blue);
        }

        /* ─── Status Filter Chips ─── */
        .status-filter {
            display: flex;
            gap: 5px;
            margin-left: 12px;
        }

        .status-chip {
            padding: 5px 11px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .status-chip:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .status-chip.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        /* ─── Checkbox ─── */
        th.th-checkbox,
        td.td-checkbox {
            width: 36px;
            text-align: center;
        }

        td.td-checkbox input[type=checkbox],
        th.th-checkbox input[type=checkbox] {
            width: 15px;
            height: 15px;
            cursor: pointer;
            accent-color: var(--accent-blue);
        }

        /* ─── Pagination ─── */
        .pendentes-paginacao {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 14px;
        }

        /* ─── Cruzamento Banco ↔ Olist ─── */
        .cruzamento-filtros {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .cruzamento-filtros select,
        .cruzamento-filtros input {
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            outline: none;
            cursor: pointer;
        }

        .cruzamento-filtros select:focus,
        .cruzamento-filtros input:focus {
            border-color: var(--accent-blue);
        }

        /* Score badge */
        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
        }

        .score-alta {
            background: rgba(16, 185, 129, .15);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, .3);
        }

        .score-media {
            background: rgba(245, 158, 11, .15);
            color: var(--accent-orange);
            border: 1px solid rgba(245, 158, 11, .3);
        }

        .score-baixa {
            background: rgba(239, 68, 68, .15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, .3);
        }

        /* Score bar mini */
        .score-bar-wrap {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, .08);
            border-radius: 2px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width .4s ease;
        }

        /* Par de cruzamento */
        .par-cruzamento {
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: border-color .2s;
        }

        .par-cruzamento:hover {
            border-color: rgba(59, 130, 246, .3);
        }

        .par-cruzamento.confirmado {
            border-color: rgba(16, 185, 129, .4);
            opacity: .6;
        }

        .par-cruzamento.rejeitado {
            border-color: rgba(239, 68, 68, .3);
            opacity: .5;
        }

        .par-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, .02);
            flex-wrap: wrap;
        }

        .par-header input[type=checkbox] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-blue);
            flex-shrink: 0;
        }

        .par-body {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: start;
            padding: 16px;
            gap: 12px;
        }

        @media(max-width:700px) {
            .par-body {
                grid-template-columns: 1fr;
            }

            .par-separador {
                display: none;
            }
        }

        .par-side {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px 14px;
        }

        .par-side-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .par-side-banco {
            border-left: 3px solid var(--accent-blue);
        }

        .par-side-olist {
            border-left: 3px solid var(--accent-purple);
        }

        .par-field {
            font-size: 13px;
            margin-bottom: 4px;
        }

        .par-field strong {
            display: block;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .par-field span {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .par-separador {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0 4px;
            color: var(--text-muted);
            font-size: 18px;
        }

        .par-detalhes {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 0 16px 14px;
        }

        .detalhe-chip {
            font-size: 11px;
            padding: 3px 9px;
            border-radius: 10px;
            background: rgba(255, 255, 255, .05);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .detalhe-chip.match {
            background: rgba(16, 185, 129, .08);
            color: var(--accent-green);
            border-color: rgba(16, 185, 129, .2);
        }

        .par-acoes {
            display: flex;
            gap: 8px;
            padding: 0 16px 14px;
            flex-wrap: wrap;
            align-items: center;
        }

        .par-ref {
            flex: 1;
            min-width: 160px;
            padding: 7px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            outline: none;
        }

        .par-ref:focus {
            border-color: var(--accent-blue);
        }

        /* Stats bar do cruzamento */
        .cruzamento-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .crz-stat {
            text-align: center;
        }

        .crz-stat .num {
            font-size: 22px;
            font-weight: 800;
        }

        .crz-stat .lbl {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        /* Paginação */
        .paginacao {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
        }

        .pg-info {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ─── Modal Anti-Duplicidade ─── */
        .modal-dup {
            background: var(--bg-card);
            border: 1px solid rgba(239, 68, 68, .4);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 560px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-dup-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .modal-dup-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(239, 68, 68, .15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .modal-dup-title {
            font-size: 17px;
            font-weight: 700;
        }

        .modal-dup-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .dup-match-item {
            background: var(--bg-secondary);
            border: 1px solid rgba(239, 68, 68, .25);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 10px;
        }

        .dup-match-item .dup-conf-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .dup-conf-alta {
            background: rgba(239, 68, 68, .15);
            color: var(--accent-red);
        }

        .dup-conf-media {
            background: rgba(245, 158, 11, .15);
            color: var(--accent-orange);
        }

        .dup-match-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .dup-match-row .dup-field label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .4px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .dup-match-row .dup-field span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .dup-motivo {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        .modal-dup-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
        }

        /* ─── Delete / Reset Modals ─── */
        .btn-delete-extrato {
            padding: 5px 10px;
            border-radius: 8px;
            background: rgba(239, 68, 68, .12);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, .25);
            font-size: 12px;
            cursor: pointer;
            transition: background .2s;
            font-family: inherit;
            white-space: nowrap;
        }

        .btn-delete-extrato:hover {
            background: rgba(239, 68, 68, .25);
        }

        .btn-reset-completo {
            padding: 6px 13px;
            border-radius: 8px;
            background: rgba(239, 68, 68, .12);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, .3);
            font-size: 12px;
            cursor: pointer;
            transition: background .2s;
            font-family: inherit;
            font-weight: 600;
        }

        .btn-reset-completo:hover {
            background: rgba(239, 68, 68, .22);
        }

        .modal-del {
            background: var(--bg-card);
            border: 1px solid rgba(239, 68, 68, .35);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 480px;
        }

        .modal-del h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-del p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .modal-del .confirm-input {
            width: 100%;
            padding: 9px 13px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 13px;
            font-family: monospace;
            margin-bottom: 16px;
            box-sizing: border-box;
            outline: none;
            transition: border-color .2s;
        }

        .modal-del .confirm-input:focus {
            border-color: var(--accent-red);
        }

        .modal-del-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>

<body>
    <div class="erp-layout">
        <!-- Sidebar injected by sidebar.js -->

        <!-- Main -->
        <main class="erp-main">
            <!-- Mobile toggle -->
            <button class="mobile-toggle" id="mobileToggle" aria-label="Menu">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12" />
                    <line x1="3" y1="6" x2="21" y2="6" />
                    <line x1="3" y1="18" x2="21" y2="18" />
                </svg>
            </button>

            <!-- Breadcrumb -->
            <div class="erp-breadcrumb">
                <a href="/">inicio</a>
                <span class="sep">/</span>
                <span>financas</span>
                <span class="sep">/</span>
                <span class="current">conciliacao bancaria</span>
            </div>

            <div class="erp-content">
                <div class="app">
                    <!-- Page Header -->
                    <div class="page-header">
                        <h1>Conciliacao Bancaria</h1>
                    </div>

                    <!-- KPI Cards -->
                    <div class="cards" id="cards">
                        <div class="card blue">
                            <div class="label">Total Olist</div>
                            <div class="value" id="kpi-total">—</div>
                            <div class="sub" id="kpi-total-sub">carregando...</div>
                        </div>
                        <div class="card green">
                            <div class="label">Classificados</div>
                            <div class="value" id="kpi-class">—</div>
                            <div class="progress-bar">
                                <div class="progress-fill green" id="kpi-class-bar" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="card red">
                            <div class="label">Pendentes</div>
                            <div class="value" id="kpi-pend">—</div>
                            <div class="sub" id="kpi-pend-sub"></div>
                        </div>
                        <div class="card purple">
                            <div class="label">Extratos Banco</div>
                            <div class="value" id="kpi-banco">—</div>
                            <div class="sub" id="kpi-banco-sub"></div>
                        </div>
                    </div>

                    <!-- Upload Zone -->
                    <div class="upload-section">
                        <div class="upload-zone" id="upload-zone">
                            <div class="upload-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg></div>
                            <h3>Enviar Extrato Bancário</h3>
                            <p>Arraste OFX ou PDF aqui, ou toque para selecionar</p>
                            <input type="file" id="file-input" accept=".ofx,.pdf">
                        </div>
                        <div id="preview-area" class="hidden"></div>
                    </div>

                    <!-- Extratos Importados -->
                    <div class="section" id="extratos-section">
                        <div class="section-header">
                            <h2>Extratos Importados</h2>
                            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                                <button class="btn-reset-completo" onclick="abrirResetCompleto()">Reset
                                    Completo</button>
                                <button class="btn btn-outline btn-sm" onclick="loadExtratos()">↻ Atualizar</button>
                            </div>
                        </div>
                        <div id="extratos-list">
                            <p style="color:var(--text-muted);font-size:13px">Nenhum extrato importado ainda</p>
                        </div>
                    </div>

                    <!-- Filtro Universal -->
                    <div id="filtro-pendentes"></div>

                    <!-- Pendentes -->
                    <div class="section" id="pendentes-section">
                        <div class="section-header">
                            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                <h2>Transacoes</h2>
                                <div class="status-filter" id="status-filter">
                                    <button class="status-chip active" data-status="pendentes">Pendentes</button>
                                    <button class="status-chip" data-status="classificados">Classificados</button>
                                    <button class="status-chip" data-status="todos">Todos</button>
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn btn-primary btn-sm" onclick="autoClassificar()">
                                    Auto-Classificar</button>
                                <button class="btn btn-outline btn-sm" onclick="loadPendentes()">↻ Atualizar</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="th-checkbox"><input type="checkbox" id="chk-select-all"
                                                onchange="toggleSelectAll(this)" title="Selecionar todos"></th>
                                        <th class="sortable" data-col="data" onclick="toggleSort('data')">Data <span
                                                class="sort-arrow">↓</span></th>
                                        <th>Descrição</th>
                                        <th class="sortable" data-col="valor" onclick="toggleSort('valor')">Valor <span
                                                class="sort-arrow">↕</span></th>
                                        <th>Conta</th>
                                        <th class="sortable" data-col="categoria" onclick="toggleSort('categoria')">
                                            Categoria <span class="sort-arrow">↕</span></th>
                                    </tr>
                                </thead>
                                <tbody id="pendentes-body"></tbody>
                            </table>
                        </div>
                        <div id="batch-bar-wrap"></div>
                        <div class="pendentes-paginacao" id="pendentes-paginacao" style="display:none">
                            <button class="btn btn-outline btn-sm" id="pend-btn-prev" onclick="pendPrevPage()">←
                                Anterior</button>
                            <span class="pg-info" id="pend-pg-info"></span>
                            <button class="btn btn-outline btn-sm" id="pend-btn-next" onclick="pendNextPage()">Próxima
                                →</button>
                        </div>
                    </div>

                    <!-- ═══════════════════════════════════════════════
             SEÇÃO DE CRUZAMENTO BANCO ↔ OLIST
        ═══════════════════════════════════════════════ -->
                    <div class="section" id="cruzamento-section">
                        <div class="section-header">
                            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                                <h2>Cruzamento Banco / Olist</h2>
                                <span class="badge badge-blue" id="crz-badge">—</span>
                            </div>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn btn-primary btn-sm" id="btn-executar-crz"
                                    onclick="executarCruzamento()">
                                    Executar Cruzamento</button>
                                <button class="btn btn-success btn-sm" id="btn-confirmar-alta"
                                    onclick="confirmarTodosAlta()" disabled>Confirmar Alta Confianca</button>
                                <button class="btn btn-outline btn-sm" onclick="loadCruzamento()">↻ Atualizar</button>
                            </div>
                        </div>

                        <!-- Filtros -->
                        <div class="cruzamento-filtros">
                            <select id="crz-banco" onchange="loadCruzamento()">
                                <option value="">Todos os Bancos</option>
                                <option value="olist">Olist Conta Digital</option>
                                <option value="santander">Santander</option>
                                <option value="cresol">Cresol</option>
                                <option value="caixa">Caixa Econômica</option>
                                <option value="mercado_pago">Mercado Pago</option>
                            </select>
                            <select id="crz-confianca" onchange="renderCruzamentoPage()">
                                <option value="">Todos</option>
                                <option value="alta">Alta Confiança (≥75)</option>
                                <option value="media">Média (50-74)</option>
                                <option value="baixa">Baixa (&lt;50)</option>
                            </select>
                            <select id="crz-score-min" onchange="executarCruzamento()">
                                <option value="45">Score mín: 45</option>
                                <option value="50">Score mín: 50</option>
                                <option value="60">Score mín: 60</option>
                                <option value="30">Score mín: 30</option>
                            </select>
                            <select id="crz-limite" onchange="executarCruzamento()">
                                <option value="50">50 transações</option>
                                <option value="100" selected>100 transações</option>
                                <option value="200">200 transações</option>
                                <option value="500">500 transações</option>
                            </select>
                        </div>

                        <!-- Stats -->
                        <div class="cruzamento-stats" id="crz-stats" style="display:none">
                            <div class="crz-stat">
                                <div class="num" id="crz-total">—</div>
                                <div class="lbl">Analisadas</div>
                            </div>
                            <div class="crz-stat">
                                <div class="num" id="crz-matches" style="color:var(--accent-blue)">—</div>
                                <div class="lbl">Matches</div>
                            </div>
                            <div class="crz-stat">
                                <div class="num" id="crz-alta" style="color:var(--accent-green)">—</div>
                                <div class="lbl">Alta Confiança</div>
                            </div>
                            <div class="crz-stat">
                                <div class="num" id="crz-media" style="color:var(--accent-orange)">—</div>
                                <div class="lbl">Média Confiança</div>
                            </div>
                            <div class="crz-stat">
                                <div class="num" id="crz-sem" style="color:var(--text-muted)">—</div>
                                <div class="lbl">Sem Match</div>
                            </div>
                            <div class="crz-stat">
                                <div class="num" id="crz-taxa" style="color:var(--accent-cyan)">—</div>
                                <div class="lbl">Taxa de Acerto</div>
                            </div>
                        </div>

                        <!-- Estado inicial -->
                        <div id="crz-inicial" style="text-align:center;padding:40px 20px;color:var(--text-muted)">
                            <div style="font-size:48px;margin-bottom:12px"><svg width="48" height="48"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" />
                                    <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" />
                                </svg></div>
                            <p style="font-size:14px">Clique em <strong style="color:var(--text-primary)">Executar
                                    Cruzamento</strong> para identificar matches automáticos entre transações bancárias
                                e
                                lançamentos Olist.</p>
                        </div>

                        <!-- Loading -->
                        <div id="crz-loading" class="hidden" style="text-align:center;padding:40px">
                            <div class="loading" style="width:32px;height:32px;border-width:3px"></div>
                            <p style="margin-top:12px;color:var(--text-secondary);font-size:13px">Cruzando transações...
                            </p>
                        </div>

                        <!-- Lista de pares -->
                        <div id="crz-lista"></div>

                        <!-- Paginação -->
                        <div class="paginacao" id="crz-paginacao" style="display:none">
                            <button class="btn btn-outline btn-sm" id="crz-btn-prev" onclick="cruzamentoPrevPage()">←
                                Anterior</button>
                            <span class="pg-info" id="crz-pg-info"></span>
                            <button class="btn btn-outline btn-sm" id="crz-btn-next"
                                onclick="cruzamentoNextPage()">Próxima
                                →</button>
                        </div>
                    </div>
                </div><!-- app -->
            </div><!-- erp-content -->
        </main><!-- erp-main -->
    </div><!-- erp-layout -->

    <!-- Modal de Classificação -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <h3>Classificar Transacao</h3>
            <div class="desc-preview" id="modal-desc"></div>
            <input type="text" class="cat-search" id="cat-search" placeholder="Buscar categoria..."
                oninput="filterCategorias()">
            <div class="cat-list" id="cat-list"></div>
            <div class="modal-actions">
                <button class="btn btn-outline btn-sm" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary btn-sm" id="btn-save-cat" onclick="saveClassificacao()"
                    disabled>Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Delete Extrato -->
    <div class="modal-overlay" id="modal-delete-overlay">
        <div class="modal-del">
            <h3>Excluir Extrato</h3>
            <p id="modal-delete-msg"></p>
            <div id="modal-delete-confirm-wrap" style="display:none">
                <p style="color:var(--accent-red);font-size:12px;margin-bottom:6px;font-weight:600">Digite
                    <code>CONFIRMAR</code> para prosseguir:
                </p>
                <input type="text" class="confirm-input" id="modal-delete-input" placeholder="CONFIRMAR"
                    oninput="checkDeleteInput()">
            </div>
            <div class="modal-del-actions">
                <button class="btn btn-outline btn-sm" onclick="fecharDeleteModal()">Cancelar</button>
                <button class="btn btn-danger btn-sm" id="btn-executar-delete" onclick="executarDeleteExtrato()">
                    Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Reset Completo -->
    <div class="modal-overlay" id="modal-reset-overlay">
        <div class="modal-del">
            <h3>Reset Completo</h3>
            <p>ATENÇÃO: Isso vai excluir <strong>TODOS</strong> os extratos, transações bancárias e lançamentos Olist.
                Esta ação é <strong>irreversível</strong>.</p>
            <p style="color:var(--accent-red);font-size:12px;margin-bottom:6px;font-weight:600">Digite
                <code>CONFIRMAR</code> para prosseguir:
            </p>
            <input type="text" class="confirm-input" id="modal-reset-input" placeholder="CONFIRMAR"
                oninput="checkResetInput()">
            <div class="modal-del-actions">
                <button class="btn btn-outline btn-sm" onclick="fecharResetModal()">Cancelar</button>
                <button class="btn btn-danger btn-sm" id="btn-executar-reset" disabled
                    onclick="executarResetCompleto()">Resetar Tudo</button>
            </div>
        </div>
    </div>

    <!-- Modal Anti-Duplicidade -->
    <div class="modal-overlay" id="modal-dup-overlay">
        <div class="modal-dup">
            <div class="modal-dup-header">
                <div class="modal-dup-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
                        <line x1="12" y1="9" x2="12" y2="13" />
                        <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg></div>
                <div>
                    <div class="modal-dup-title">Possível Duplicata Detectada</div>
                    <div class="modal-dup-subtitle" id="dup-subtitle">Este lançamento pode já existir no Olist.</div>
                </div>
            </div>
            <div id="dup-matches-list"></div>
            <div class="modal-dup-actions">
                <button class="btn btn-outline btn-sm" id="btn-dup-cancelar" onclick="closeDupModal()">✗
                    Cancelar</button>
                <button class="btn btn-danger btn-sm" id="btn-dup-prosseguir">⚡ Enviar mesmo assim</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const API = '/api/conciliacao';
        let categorias = [];
        let currentItem = null;
        let selectedCat = null;
        let pendentesOffset = 0;

        // ─── Filter & Sort State ───
        let filtroUniversal = null;
        let currentFilters = {};
        let currentStatus = 'pendentes';
        let sortCol = 'data';
        let sortDir = 'DESC';
        let pendPage = 0;
        const PEND_PER_PAGE = 50;
        let pendTotal = 0;
        let selectedItems = new Set();

        // ─── Init ───
        document.addEventListener('DOMContentLoaded', async () => {
            loadResumo();
            loadExtratos();
            await loadCategorias();
            await initFiltros();
            loadPendentes();
            setupUpload();
            setupStatusFilter();
        });

        // ─── Init Filtros ───
        async function initFiltros() {
            let bancos = [];
            try {
                const r = await fetch(`${API}/bancos`).then(r => r.json());
                if (r.sucesso) bancos = r.bancos;
            } catch (e) { console.warn('Bancos load failed:', e); }

            filtroUniversal = new FiltroUniversal({
                container: '#filtro-pendentes',
                filtros: ['data', 'banco', 'categoria'],
                bancos: bancos,
                categorias: categorias,
                onChange: (filtros) => {
                    currentFilters = filtros;
                    pendPage = 0;
                    selectedItems.clear();
                    loadPendentes();
                },
            });
        }

        // ─── Status Filter ───
        function setupStatusFilter() {
            document.querySelectorAll('.status-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.status-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentStatus = chip.dataset.status;
                    pendPage = 0;
                    selectedItems.clear();
                    loadPendentes();
                });
            });
        }

        // ─── Sort ───
        function toggleSort(col) {
            if (sortCol === col) {
                sortDir = sortDir === 'DESC' ? 'ASC' : 'DESC';
            } else {
                sortCol = col;
                sortDir = 'DESC';
            }
            // Update UI
            document.querySelectorAll('th.sortable').forEach(th => {
                const arrow = th.querySelector('.sort-arrow');
                if (th.dataset.col === col) {
                    th.classList.add('sort-active');
                    arrow.textContent = sortDir === 'DESC' ? '↓' : '↑';
                } else {
                    th.classList.remove('sort-active');
                    arrow.textContent = '↕';
                }
            });
            pendPage = 0;
            loadPendentes();
        }

        // ─── Load Resumo ───
        async function loadResumo() {
            try {
                const r = await fetch(`${API}/resumo`).then(r => r.json());
                if (!r.sucesso) return;
                document.getElementById('kpi-total').textContent = r.olist.total.toLocaleString('pt-BR');
                document.getElementById('kpi-total-sub').textContent = `${r.olist.percentual}% classificados`;
                document.getElementById('kpi-class').textContent = r.olist.classificados.toLocaleString('pt-BR');
                document.getElementById('kpi-class-bar').style.width = r.olist.percentual + '%';
                document.getElementById('kpi-pend').textContent = (r.olist.pendentes + (r.banco.pendentes || 0)).toLocaleString('pt-BR');
                document.getElementById('kpi-pend-sub').textContent = `Olist: ${r.olist.pendentes} | Banco: ${r.banco.pendentes || 0}`;
                document.getElementById('kpi-banco').textContent = r.banco.total.toLocaleString('pt-BR');
                document.getElementById('kpi-banco-sub').textContent = `${r.extratos} extrato(s) | ${r.banco.percentual}% class.`;
            } catch (e) { console.error(e); }
        }

        // ─── Upload Setup ───
        function setupUpload() {
            const zone = document.getElementById('upload-zone');
            const input = document.getElementById('file-input');
            zone.addEventListener('click', () => input.click());
            zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
            input.addEventListener('change', () => { if (input.files.length) handleFile(input.files[0]); });
        }

        async function handleFile(file) {
            const zone = document.getElementById('upload-zone');
            const preview = document.getElementById('preview-area');
            zone.classList.add('processing');
            zone.innerHTML = '<div class="loading"></div><h3 style="margin-top:12px">Processando...</h3><p>' + file.name + '</p>';

            const fd = new FormData();
            fd.append('file', file);

            try {
                const r = await fetch(`${API}/upload`, { method: 'POST', body: fd }).then(r => r.json());
                if (!r.sucesso) throw new Error(r.erro);

                const p = r.preview;
                preview.classList.remove('hidden');
                preview.innerHTML = `
            <div class="preview-result">
                <div class="stats">
                    <div class="stat"><div class="num">${p.total}</div><div class="lbl">Transações</div></div>
                    <div class="stat"><div class="num" style="color:var(--accent-green)">${p.classificados}</div><div class="lbl">Classificados</div></div>
                    <div class="stat"><div class="num" style="color:var(--accent-orange)">${p.pendentes}</div><div class="lbl">Pendentes</div></div>
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">
                    🏦 <strong>${bancoLabel(p.banco)}</strong> • ${p.formato.toUpperCase()} • ${p.periodo.inicio} → ${p.periodo.fim}
                </p>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn btn-success btn-sm" onclick="saveUpload()">💾 Salvar no Banco</button>
                    <button class="btn btn-outline btn-sm" onclick="cancelUpload()">Cancelar</button>
                </div>
            </div>`;
                // Store file for save
                preview.dataset.file = file.name;
                window._pendingFile = file;
            } catch (e) {
                showToast('Erro: ' + e.message, true);
            }
            zone.classList.remove('processing');
            zone.innerHTML = '<div class="icon">📄</div><h3>Enviar Extrato Bancário</h3><p>Arraste OFX ou PDF aqui, ou toque para selecionar</p><input type="file" id="file-input" accept=".ofx,.pdf">';
            setupUpload();
        }

        async function saveUpload() {
            if (!window._pendingFile) return;
            const fd = new FormData();
            fd.append('file', window._pendingFile);
            try {
                const r = await fetch(`${API}/upload-save`, { method: 'POST', body: fd }).then(r => r.json());
                if (!r.sucesso) throw new Error(r.erro);
                showToast(`✅ Extrato #${r.extratoId} salvo — ${r.total} transações`);
                cancelUpload();
                loadResumo();
                loadExtratos();
                loadPendentes();
            } catch (e) { showToast('Erro: ' + e.message, true); }
        }

        function cancelUpload() {
            document.getElementById('preview-area').classList.add('hidden');
            window._pendingFile = null;
        }

        // ─── Extratos ───
        async function loadExtratos() {
            try {
                const r = await fetch(`${API}/extratos`).then(r => r.json());
                const el = document.getElementById('extratos-list');
                if (!r.sucesso || !r.extratos.length) { el.innerHTML = '<p style="color:var(--text-muted);font-size:13px">Nenhum extrato importado ainda</p>'; return; }
                el.innerHTML = r.extratos.map(e => `
            <div class="extrato-item">
                <div class="banco-icon" style="background:${bancoColor(e.banco)}">${bancoEmoji(e.banco)}</div>
                <div class="info">
                    <h4>${bancoLabel(e.banco)}</h4>
                    <p>${e.periodo_inicio || '—'} → ${e.periodo_fim || '—'} • ${e.formato.toUpperCase()}</p>
                </div>
                <div class="stats-mini">
                    <span>📊 ${e.total_transacoes} txns</span>
                    <span style="color:var(--accent-green)">✅ ${e.classificados}</span>
                    <span style="color:var(--accent-orange)">⏳ ${e.pendentes}</span>
                </div>
                <button class="btn-delete-extrato" onclick="confirmarDeleteExtrato(${e.id}, ${e.total_transacoes}, '${bancoLabel(e.banco).replace(/'/g, "'")}', '${(e.periodo_inicio || '').replace(/'/g, "'")} → ${(e.periodo_fim || '').replace(/'/g, "'")}')">
                    🗑️ Excluir
                </button>
            </div>`).join('');
            } catch (e) { console.error(e); }
        }

        // ─── Delete Extrato ───
        let _deleteExtratoId = null;
        let _deleteExigeConfirmacao = false;

        function confirmarDeleteExtrato(id, txns, banco, periodo) {
            _deleteExtratoId = id;
            _deleteExigeConfirmacao = txns > 100;
            const msg = document.getElementById('modal-delete-msg');
            msg.innerHTML = `Tem certeza? Isso vai excluir o extrato <strong>${banco}</strong> (${periodo}) e suas <strong>${txns} transação(ões)</strong>. Esta ação é irreversível.`;
            const wrap = document.getElementById('modal-delete-confirm-wrap');
            wrap.style.display = _deleteExigeConfirmacao ? 'block' : 'none';
            const input = document.getElementById('modal-delete-input');
            input.value = '';
            const btn = document.getElementById('btn-executar-delete');
            btn.disabled = _deleteExigeConfirmacao; // habilitado só se não exige confirmação
            document.getElementById('modal-delete-overlay').classList.add('active');
        }

        function checkDeleteInput() {
            const val = document.getElementById('modal-delete-input').value;
            document.getElementById('btn-executar-delete').disabled = (val !== 'CONFIRMAR');
        }

        function fecharDeleteModal() {
            document.getElementById('modal-delete-overlay').classList.remove('active');
            _deleteExtratoId = null;
        }

        async function executarDeleteExtrato() {
            if (!_deleteExtratoId) return;
            const id = _deleteExtratoId;
            fecharDeleteModal();
            try {
                const r = await fetch(`${API}/extratos/${id}`, { method: 'DELETE' }).then(r => r.json());
                if (!r.sucesso) throw new Error(r.erro);
                showToast(`🗑️ Extrato #${r.extratoId} (${r.banco}) excluído — ${r.transacoesRemovidas} transações removidas`);
                loadExtratos();
                loadResumo();
                loadPendentes();
            } catch (e) { showToast('Erro: ' + e.message, true); }
        }

        // ─── Reset Completo ───
        function abrirResetCompleto() {
            document.getElementById('modal-reset-input').value = '';
            document.getElementById('btn-executar-reset').disabled = true;
            document.getElementById('modal-reset-overlay').classList.add('active');
        }

        function checkResetInput() {
            const val = document.getElementById('modal-reset-input').value;
            document.getElementById('btn-executar-reset').disabled = (val !== 'CONFIRMAR');
        }

        function fecharResetModal() {
            document.getElementById('modal-reset-overlay').classList.remove('active');
        }

        async function executarResetCompleto() {
            fecharResetModal();
            try {
                const r = await fetch(`${API}/extratos/reset-completo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirmar: 'CONFIRMAR' }),
                }).then(r => r.json());
                if (!r.sucesso) throw new Error(r.erro);
                showToast(`⚠️ Reset concluído — ${r.extratosRemovidos} extratos, ${r.transacoesRemovidas} txns, ${r.lancamentosRemovidos} lançamentos removidos`);
                loadExtratos();
                loadResumo();
                loadPendentes();
            } catch (e) { showToast('Erro: ' + e.message, true); }
        }

        // ─── Pendentes ───
        async function loadPendentes() {
            const body = document.getElementById('pendentes-body');
            body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--text-muted)"><div class="loading"></div></td></tr>';

            try {
                const params = new URLSearchParams();
                params.set('limite', PEND_PER_PAGE);
                params.set('offset', pendPage * PEND_PER_PAGE);
                params.set('status', currentStatus);
                params.set('orderBy', sortCol);
                params.set('orderDir', sortDir);

                if (currentFilters.dataInicio) params.set('dataInicio', currentFilters.dataInicio);
                if (currentFilters.dataFim) params.set('dataFim', currentFilters.dataFim);
                if (currentFilters.banco && currentFilters.banco.length === 1) params.set('banco', currentFilters.banco[0]);
                if (currentFilters.categoria) params.set('categoria', currentFilters.categoria);

                const r = await fetch(`${API}/pendentes?${params}`).then(r => r.json());
                if (!r.sucesso || !r.pendentes.length) {
                    body.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--accent-green);padding:30px">🎉 Nenhuma transação encontrada</td></tr>';
                    document.getElementById('pendentes-paginacao').style.display = 'none';
                    updateBatchBar();
                    return;
                }

                pendTotal = r.total;
                body.innerHTML = r.pendentes.map((p, i) => renderPendenteRow(p, i)).join('');

                // Pagination
                const totalPages = Math.ceil(pendTotal / PEND_PER_PAGE);
                if (totalPages > 1) {
                    document.getElementById('pendentes-paginacao').style.display = 'flex';
                    document.getElementById('pend-pg-info').textContent = `Pág. ${pendPage + 1} de ${totalPages} (${pendTotal} total)`;
                    document.getElementById('pend-btn-prev').disabled = pendPage === 0;
                    document.getElementById('pend-btn-next').disabled = pendPage >= totalPages - 1;
                } else {
                    document.getElementById('pendentes-paginacao').style.display = 'none';
                }

                // Reset selection
                document.getElementById('chk-select-all').checked = false;
                updateBatchBar();
            } catch (e) { console.error(e); body.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--accent-red);padding:30px">Erro ao carregar</td></tr>'; }
        }

        function pendPrevPage() {
            if (pendPage > 0) { pendPage--; selectedItems.clear(); loadPendentes(); }
        }

        function pendNextPage() {
            const totalPages = Math.ceil(pendTotal / PEND_PER_PAGE);
            if (pendPage < totalPages - 1) { pendPage++; selectedItems.clear(); loadPendentes(); }
        }

        function renderPendenteRow(p, idx) {
            const val = Math.abs(p.valor);
            const valFmt = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const desc = (p.descricao || '').substring(0, 60) + ((p.descricao || '').length > 60 ? '...' : '');
            const itemKey = `${p.tabela}-${p.id}`;
            const isChecked = selectedItems.has(itemKey) ? 'checked' : '';

            let catCell;
            if (p.categoria) {
                catCell = `<span class="cat-badge cat-auto" title="${p.categoria}">${p.categoria.length > 25 ? p.categoria.substring(0, 25) + '…' : p.categoria}</span>`;
            } else {
                catCell = `<span class="cat-badge cat-pending" onclick='openModal(${JSON.stringify(p).replace(/'/g, "&#39;")})'>⚠️ Classificar</span>`;
            }

            return `<tr data-item-key="${itemKey}">
        <td class="td-checkbox"><input type="checkbox" ${isChecked} onchange="toggleItemSelect('${itemKey}', ${JSON.stringify(p).replace(/"/g, '&quot;')})" /></td>
        <td style="white-space:nowrap">${p.data || '—'}</td>
        <td title="${(p.descricao || '').replace(/"/g, '&quot;')}">${desc}</td>
        <td class="tipo-${p.tipo}">${p.tipo === 'C' ? '+' : '−'} ${valFmt}</td>
        <td style="font-size:11px;color:var(--text-secondary)">${(p.conta || p.banco || '').substring(0, 20)}</td>
        <td>${catCell}</td>
    </tr>`;
        }

        // ─── Selection / Batch ───
        let selectedItemsData = {};

        function toggleItemSelect(key, itemData) {
            if (selectedItems.has(key)) {
                selectedItems.delete(key);
                delete selectedItemsData[key];
            } else {
                selectedItems.add(key);
                selectedItemsData[key] = itemData;
            }
            updateBatchBar();
        }

        function toggleSelectAll(el) {
            const checkboxes = document.querySelectorAll('#pendentes-body input[type=checkbox]');
            selectedItems.clear();
            selectedItemsData = {};
            if (el.checked) {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    const row = cb.closest('tr');
                    const key = row.dataset.itemKey;
                    selectedItems.add(key);
                    // Parse item data from the row key
                    const [tabela, id] = key.split('-');
                    selectedItemsData[key] = { tabela, id: parseInt(id) };
                });
            } else {
                checkboxes.forEach(cb => cb.checked = false);
            }
            updateBatchBar();
        }

        function updateBatchBar() {
            const wrap = document.getElementById('batch-bar-wrap');
            if (selectedItems.size === 0) {
                wrap.innerHTML = '';
                return;
            }

            wrap.innerHTML = `
                <div class="batch-bar">
                    <span class="batch-counter">${selectedItems.size} ${selectedItems.size === 1 ? 'item selecionado' : 'itens selecionados'}</span>
                    <select class="batch-cat-select" id="batch-cat-dropdown">
                        <option value="">Selecionar categoria...</option>
                        ${categorias.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="classificarLote()" id="btn-batch-classificar" disabled>🏷️ Classificar selecionados</button>
                    <button class="btn btn-outline btn-sm" onclick="deselecionarTudo()">✕ Limpar seleção</button>
                </div>
            `;

            document.getElementById('batch-cat-dropdown').addEventListener('change', (e) => {
                document.getElementById('btn-batch-classificar').disabled = !e.target.value;
            });
        }

        function deselecionarTudo() {
            selectedItems.clear();
            selectedItemsData = {};
            document.getElementById('chk-select-all').checked = false;
            document.querySelectorAll('#pendentes-body input[type=checkbox]').forEach(cb => cb.checked = false);
            updateBatchBar();
        }

        async function classificarLote() {
            const cat = document.getElementById('batch-cat-dropdown').value;
            if (!cat) return;

            const count = selectedItems.size;

            // Require CONFIRMAR for > 10 items
            if (count > 10) {
                const input = prompt(`Você está classificando ${count} itens como "${cat}".\nDigite CONFIRMAR para prosseguir:`);
                if (input !== 'CONFIRMAR') {
                    showToast('Classificação cancelada.', true);
                    return;
                }
            }

            // Group by tabela
            const bancoItems = [];
            const olistItems = [];
            for (const [key, data] of Object.entries(selectedItemsData)) {
                const [tabela, id] = key.split('-');
                const item = { id: parseInt(id), categoria: cat };
                if (tabela === 'banco') bancoItems.push(item);
                else olistItems.push(item);
            }

            try {
                if (bancoItems.length) {
                    await fetch(`${API}/classificar-lote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: bancoItems, tabela: 'banco' }),
                    }).then(r => r.json());
                }
                if (olistItems.length) {
                    await fetch(`${API}/classificar-lote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items: olistItems, tabela: 'olist' }),
                    }).then(r => r.json());
                }

                showToast(`✅ ${count} itens classificados como "${cat.substring(0, 30)}"`);
                selectedItems.clear();
                selectedItemsData = {};
                loadPendentes();
                loadResumo();
            } catch (e) { showToast('Erro: ' + e.message, true); }
        }

        // Keep legacy reference for loadMorePendentes calls elsewhere
        async function loadMorePendentes() {
            pendPage++;
            loadPendentes();
        }

        // ─── Auto-Classificar ───
        async function autoClassificar() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Processando...';
            try {
                const r = await fetch(`${API}/auto-classificar`, { method: 'POST' }).then(r => r.json());
                if (r.sucesso) {
                    showToast(`🤖 ${r.classificados} classificados automaticamente! ${r.restantes} restantes.`);
                    loadResumo();
                    loadPendentes();
                } else throw new Error(r.erro);
            } catch (e) { showToast('Erro: ' + e.message, true); }
            btn.disabled = false;
            btn.innerHTML = '🤖 Auto-Classificar';
        }

        // ─── Modal Classificação ───
        async function loadCategorias() {
            try {
                const r = await fetch(`${API}/categorias`).then(r => r.json());
                if (r.sucesso) categorias = r.categorias;
            } catch (e) { console.error(e); }
        }

        function openModal(item) {
            currentItem = item;
            selectedCat = null;
            document.getElementById('modal-desc').textContent = `${item.data} — ${item.descricao} — R$ ${Math.abs(item.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('cat-search').value = '';
            document.getElementById('btn-save-cat').disabled = true;
            renderCatList(categorias);
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            currentItem = null;
        }

        function filterCategorias() {
            const q = document.getElementById('cat-search').value.toLowerCase();
            renderCatList(categorias.filter(c => c.toLowerCase().includes(q)));
        }

        function renderCatList(cats) {
            document.getElementById('cat-list').innerHTML = cats.map(c =>
                `<div class="cat-item ${selectedCat === c ? 'selected' : ''}" onclick="selectCat('${c.replace(/'/g, "\\'")}')">${c}</div>`
            ).join('');
        }

        function selectCat(cat) {
            selectedCat = cat;
            document.getElementById('btn-save-cat').disabled = false;
            renderCatList(categorias.filter(c => {
                const q = document.getElementById('cat-search').value.toLowerCase();
                return !q || c.toLowerCase().includes(q);
            }));
        }

        async function saveClassificacao() {
            if (!currentItem || !selectedCat) return;
            try {
                const r = await fetch(`${API}/classificar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentItem.id, categoria: selectedCat, tabela: currentItem.tabela })
                }).then(r => r.json());
                if (r.sucesso) {
                    showToast(`✅ Classificado: ${selectedCat.substring(0, 30)}`);
                    closeModal();
                    loadPendentes();
                    loadResumo();
                }
            } catch (e) { showToast('Erro: ' + e.message, true); }
        }

        // Close modal on overlay click
        document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

        // ═══════════════════════════════════════════════
        //  CRUZAMENTO BANCO ↔ OLIST
        // ═══════════════════════════════════════════════
        let cruzamentoPares = [];     // todos os pares retornados
        let cruzamentoFiltrados = []; // após filtro de confiança
        let cruzamentoPage = 0;
        const CRZ_PER_PAGE = 20;

        // Executa cruzamento via API
        async function executarCruzamento() {
            const banco = document.getElementById('crz-banco').value;
            const scoreMin = document.getElementById('crz-score-min').value || 45;
            const limite = document.getElementById('crz-limite').value || 100;

            document.getElementById('crz-inicial').classList.add('hidden');
            document.getElementById('crz-loading').classList.remove('hidden');
            document.getElementById('crz-lista').innerHTML = '';
            document.getElementById('crz-stats').style.display = 'none';
            document.getElementById('crz-paginacao').style.display = 'none';
            document.getElementById('btn-executar-crz').disabled = true;
            document.getElementById('btn-executar-crz').innerHTML = '<span class="loading"></span> Cruzando...';

            try {
                const url = `${API}/cruzamento?limite=${limite}&scoreMinimo=${scoreMin}${banco ? '&banco=' + banco : ''}`;
                const r = await fetch(url).then(r => r.json());
                if (!r.sucesso) throw new Error(r.erro || 'Erro no cruzamento');

                cruzamentoPares = r.pares || [];
                cruzamentoPage = 0;

                // Atualiza stats
                const alta = cruzamentoPares.filter(p => p.confianca === 'alta').length;
                const media = cruzamentoPares.filter(p => p.confianca === 'media').length;
                const taxa = r.total > 0 ? ((r.matches / r.total) * 100).toFixed(0) : 0;

                document.getElementById('crz-total').textContent = r.total;
                document.getElementById('crz-matches').textContent = r.matches;
                document.getElementById('crz-alta').textContent = alta;
                document.getElementById('crz-media').textContent = media;
                document.getElementById('crz-sem').textContent = r.semMatch;
                document.getElementById('crz-taxa').textContent = taxa + '%';
                document.getElementById('crz-badge').textContent = `${r.matches} matches`;
                document.getElementById('crz-stats').style.display = 'grid';

                // Habilita botão de confirmar alta
                document.getElementById('btn-confirmar-alta').disabled = alta === 0;

                renderCruzamentoPage();
                showToast(`🔗 ${r.matches} matches encontrados (${alta} alta, ${media} média)`);
            } catch (e) {
                showToast('Erro: ' + e.message, true);
                document.getElementById('crz-inicial').classList.remove('hidden');
            }

            document.getElementById('crz-loading').classList.add('hidden');
            document.getElementById('btn-executar-crz').disabled = false;
            document.getElementById('btn-executar-crz').innerHTML = '🔍 Executar Cruzamento';
        }

        // Carrega cruzamento já salvo (sem re-executar)
        async function loadCruzamento() {
            await executarCruzamento();
        }

        // Aplica filtro de confiança e renderiza página atual
        function renderCruzamentoPage() {
            const filtroConf = document.getElementById('crz-confianca').value;
            cruzamentoFiltrados = filtroConf
                ? cruzamentoPares.filter(p => p.confianca === filtroConf)
                : cruzamentoPares;

            const total = cruzamentoFiltrados.length;
            const totalPages = Math.ceil(total / CRZ_PER_PAGE);
            const start = cruzamentoPage * CRZ_PER_PAGE;
            const slice = cruzamentoFiltrados.slice(start, start + CRZ_PER_PAGE);

            document.getElementById('crz-lista').innerHTML = slice.length === 0
                ? '<div style="text-align:center;padding:32px;color:var(--text-muted)">Nenhum match com este filtro</div>'
                : slice.map((p, i) => renderParCruzamento(p, start + i)).join('');

            // Paginação
            if (total > CRZ_PER_PAGE) {
                document.getElementById('crz-paginacao').style.display = 'flex';
                document.getElementById('crz-pg-info').textContent = `Pág. ${cruzamentoPage + 1} de ${totalPages} (${total} matches)`;
                document.getElementById('crz-btn-prev').disabled = cruzamentoPage === 0;
                document.getElementById('crz-btn-next').disabled = cruzamentoPage >= totalPages - 1;
            } else {
                document.getElementById('crz-paginacao').style.display = 'none';
            }
        }

        function cruzamentoPrevPage() {
            if (cruzamentoPage > 0) { cruzamentoPage--; renderCruzamentoPage(); window.scrollTo(0, document.getElementById('cruzamento-section').offsetTop - 20); }
        }

        function cruzamentoNextPage() {
            const totalPages = Math.ceil(cruzamentoFiltrados.length / CRZ_PER_PAGE);
            if (cruzamentoPage < totalPages - 1) { cruzamentoPage++; renderCruzamentoPage(); window.scrollTo(0, document.getElementById('cruzamento-section').offsetTop - 20); }
        }

        // Renderiza um par de cruzamento
        function renderParCruzamento(par, idx) {
            const banco = par.transacao_banco;
            const olist = par.lancamento_olist;
            const score = par.score;
            const conf = par.confianca;

            const scoreClass = conf === 'alta' ? 'score-alta' : conf === 'media' ? 'score-media' : 'score-baixa';
            const scoreIcon = conf === 'alta' ? '🟢' : conf === 'media' ? '🟡' : '🔴';
            const scoreBarColor = conf === 'alta' ? 'var(--accent-green)' : conf === 'media' ? 'var(--accent-orange)' : 'var(--accent-red)';
            const scorePct = Math.min(100, Math.round((score / 170) * 100));

            const fmtVal = v => Math.abs(parseFloat(v) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // Chips de detalhes
            const detalhes = par.detalhes || {};
            const chips = Object.entries(detalhes).map(([k, v]) => {
                const isBom = v.includes('exato') || v.includes('match') || v.includes('encontrado') || v.includes('mapping') || v.includes('recorrente');
                return `<span class="detalhe-chip ${isBom ? 'match' : ''}">${chipLabel(k)}: ${v.substring(0, 50)}</span>`;
            }).join('');

            return `
            <div class="par-cruzamento" id="par-${idx}" data-tx-id="${banco.id}" data-olist-id="${olist.id}">
                <div class="par-header">
                    <input type="checkbox" id="chk-${idx}" data-idx="${idx}" onchange="updateLoteBtn()">
                    <span class="score-badge ${scoreClass}">
                        ${scoreIcon} Score ${score}
                        <span class="score-bar-wrap"><div class="score-bar-fill" style="width:${scorePct}%;background:${scoreBarColor}"></div></span>
                    </span>
                    <span style="font-size:11px;color:var(--text-muted);margin-left:auto">
                        Banco: <strong style="color:var(--text-secondary)">${bancoLabel(banco.banco)}</strong>
                    </span>
                </div>
                <div class="par-body">
                    <div class="par-side par-side-banco">
                        <div class="par-side-label">🏦 Transação Bancária</div>
                        <div class="par-field">
                            <strong class="tipo-${banco.tipo}">${fmtVal(banco.valor)}</strong>
                            <span>${banco.data || '—'} • ${banco.tipo === 'C' ? 'Crédito' : 'Débito'}</span>
                        </div>
                        <div class="par-field" style="font-size:12px;color:var(--text-secondary);word-break:break-word">
                            ${(banco.descricao || '—').substring(0, 80)}
                        </div>
                        ${banco.categoria ? `<div style="margin-top:6px"><span class="cat-badge cat-auto">${banco.categoria}</span></div>` : ''}
                    </div>
                    <div class="par-separador">⇌</div>
                    <div class="par-side par-side-olist">
                        <div class="par-side-label">💜 Lançamento Olist</div>
                        <div class="par-field">
                            <strong class="tipo-${olist.tipo}">${fmtVal(olist.valor)}</strong>
                            <span>${olist.data || '—'} • ${olist.conta || '—'}</span>
                        </div>
                        <div class="par-field" style="font-size:12px;color:var(--text-secondary);word-break:break-word">
                            ${(olist.historico || '—').substring(0, 80)}
                        </div>
                        ${olist.contato ? `<div style="margin-top:4px;font-size:11px;color:var(--text-muted)">👤 ${olist.contato.substring(0, 40)}</div>` : ''}
                        ${olist.categoria ? `<div style="margin-top:6px"><span class="cat-badge cat-auto">${olist.categoria}</span></div>` : ''}
                    </div>
                </div>
                ${chips ? `<div class="par-detalhes">${chips}</div>` : ''}
                <div class="par-acoes">
                    <input class="par-ref" type="text" placeholder="Ref. NF, observação..." id="ref-${idx}">
                    <button class="btn btn-success btn-sm" onclick="confirmarPar(${idx})">✅ Confirmar</button>
                    <button class="btn btn-outline btn-sm" id="btn-rej-${idx}" onclick="rejeitarPar(${idx})">✗ Rejeitar</button>
                    <button class="btn btn-outline btn-sm" style="font-size:11px" onclick="verAlternativas(${idx})" ${!par.alternativas || par.alternativas.length === 0 ? 'disabled' : ''}>± ${(par.alternativas || []).length} alt.</button>
                </div>
            </div>`;
        }

        function chipLabel(k) {
            return { valor: 'Valor', data: 'Data', cnpj: 'CNPJ', fornecedor: 'Fornecedor', descricao: 'Descrição', learnedMapping: 'Mapping', historicoRepetitivo: 'Histórico', tipo: 'Tipo' }[k] || k;
        }

        // ═══════════════════════════════════════════════
        //  ANTI-DUPLICIDADE
        // ═══════════════════════════════════════════════

        let _dupCallback = null; // callback de "prosseguir mesmo assim"

        /** Fecha o modal de duplicidade */
        function closeDupModal() {
            document.getElementById('modal-dup-overlay').classList.remove('active');
            _dupCallback = null;
        }

        /** Formata valor monetário */
        const fmtBRL = v => Math.abs(parseFloat(v) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        /**
         * Exibe o modal de alerta de duplicidade.
         * @param {Array} matches — lista de matches da API
         * @param {string} motivo — descrição do motivo
         * @param {Function} onProsseguir — callback se usuário decidir enviar mesmo assim
         */
        function showModalDuplicidade(matches, motivo, onProsseguir) {
            const plural = matches.length > 1 ? `${matches.length} possíveis duplicatas` : '1 possível duplicata';
            document.getElementById('dup-subtitle').textContent = `${plural} encontrada(s) no Olist. Verifique antes de confirmar.`;

            document.getElementById('dup-matches-list').innerHTML = matches.map(m => {
                const confClass = m.confianca === 'alta' ? 'dup-conf-alta' : 'dup-conf-media';
                const confLabel = m.confianca === 'alta' ? '🔴 Alta probabilidade' : '🟡 Média probabilidade';
                return `
                    <div class="dup-match-item">
                        <span class="dup-conf-badge ${confClass}">${confLabel}</span>
                        <div class="dup-match-row">
                            <div class="dup-field"><label>Valor</label><span>${fmtBRL(m.valor)}</span></div>
                            <div class="dup-field"><label>Data</label><span>${m.data || '—'}</span></div>
                            <div class="dup-field"><label>Fornecedor</label><span>${(m.fornecedor || '—').substring(0, 35)}</span></div>
                            <div class="dup-field"><label>Conta Olist</label><span>${m.conta || '—'}</span></div>
                        </div>
                        <div class="dup-motivo">Motivo: ${m.motivo}</div>
                    </div>`;
            }).join('');

            _dupCallback = onProsseguir;
            document.getElementById('btn-dup-prosseguir').onclick = () => {
                closeDupModal();
                if (_dupCallback) _dupCallback();
            };

            document.getElementById('modal-dup-overlay').classList.add('active');
        }

        /**
         * Verifica duplicidade via API.
         * @returns {{ duplicado, confianca, matches, motivo }}
         */
        async function verificarDuplicidadeAPI({ valor, data, fornecedor, cnpj }) {
            try {
                const r = await fetch(`${API}/verificar-duplicidade`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valor, data, fornecedor, cnpj })
                }).then(r => r.json());
                if (!r.sucesso) throw new Error(r.erro);
                return r;
            } catch (e) {
                console.warn('[anti-dup] Erro na verificação, prosseguindo:', e.message);
                return { duplicado: false, confianca: 'nenhuma', matches: [], motivo: e.message };
            }
        }

        // ── Execução real do cruzamento (sem verificação de duplicidade) ──────
        async function _executarConfirmacaoPar(txId, olistId, idx) {
            const el = document.getElementById(`par-${idx}`);
            const r = await fetch(`${API}/confirmar-cruzamento`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ transacaoBancoId: txId, lancamentoOlistId: olistId })
            }).then(r => r.json());

            if (r.sucesso) {
                el.classList.add('confirmado');
                el.querySelector('.par-acoes').innerHTML = '<span style="color:var(--accent-green);font-size:13px;font-weight:600">✅ Confirmado</span>';
                el.querySelector(`#chk-${idx}`)?.setAttribute('disabled', true);
                showToast('✅ Cruzamento confirmado!');
                loadResumo();
            } else {
                throw new Error(r.erro);
            }
        }

        // Confirmar um único par (COM verificação de duplicidade)
        async function confirmarPar(idx) {
            const el = document.getElementById(`par-${idx}`);
            const txId = parseInt(el.dataset.txId);
            const olistId = parseInt(el.dataset.olistId);

            // Extrair dados do lançamento Olist do par atual
            const par = cruzamentoFiltrados[idx] || cruzamentoPares.find(p => p.lancamento_olist && p.lancamento_olist.id === olistId);
            const olist = par ? par.lancamento_olist : null;

            try {
                // ── Verificação Anti-Duplicidade ──────────────────────────────
                if (olist) {
                    const check = await verificarDuplicidadeAPI({
                        valor: olist.valor,
                        data: olist.data,
                        fornecedor: olist.contato || olist.historico || '',
                        cnpj: olist.cnpj || '',
                    });

                    if (check.duplicado) {
                        showModalDuplicidade(check.matches, check.motivo, async () => {
                            try {
                                await _executarConfirmacaoPar(txId, olistId, idx);
                            } catch (e) { showToast('Erro: ' + e.message, true); }
                        });
                        return; // aguarda decisão do usuário no modal
                    }
                }
                // ── Sem duplicata: confirma diretamente ───────────────────────
                await _executarConfirmacaoPar(txId, olistId, idx);
            } catch (e) { showToast('Erro: ' + e.message, true); }
        }

        // Rejeitar (desfazer) um par
        async function rejeitarPar(idx) {
            const el = document.getElementById(`par-${idx}`);
            const txId = parseInt(el.dataset.txId);

            try {
                const r = await fetch(`${API}/desfazer-cruzamento`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transacaoBancoId: txId })
                }).then(r => r.json());

                if (r.sucesso) {
                    el.classList.add('rejeitado');
                    el.querySelector('.par-acoes').innerHTML = '<span style="color:var(--accent-red);font-size:13px;font-weight:600">✗ Rejeitado</span>';
                    el.querySelector(`#chk-${idx}`)?.remove();
                    showToast('Match rejeitado.');
                } else throw new Error(r.erro);
            } catch (e) { showToast('Erro: ' + e.message, true); }
        }

        // Confirmar todos de alta confiança (lote) — COM verificação de duplicidade
        async function confirmarTodosAlta() {
            const altaPares = cruzamentoPares.filter(p => p.confianca === 'alta');
            if (altaPares.length === 0) return;

            // Confirmação prévia do usuário
            const precisaConfirmacaoExtra = altaPares.length > 10;
            if (precisaConfirmacaoExtra) {
                const codigo = prompt(`Você está prestes a confirmar ${altaPares.length} matches de alta confiança.\nDigite CONFIRMAR para prosseguir:`);
                if (codigo !== 'CONFIRMAR') { showToast('Confirmação cancelada.', true); return; }
            } else if (!confirm(`Confirmar ${altaPares.length} matches de alta confiança (score ≥75)?`)) {
                return;
            }

            document.getElementById('btn-confirmar-alta').disabled = true;
            document.getElementById('btn-confirmar-alta').innerHTML = '<span class="loading"></span> Verificando duplicatas...';

            try {
                // ── Verificação Anti-Duplicidade em lote ─────────────────────
                const duplicatasEncontradas = [];
                for (const par of altaPares) {
                    const olist = par.lancamento_olist;
                    if (!olist) continue;
                    const check = await verificarDuplicidadeAPI({
                        valor: olist.valor,
                        data: olist.data,
                        fornecedor: olist.contato || olist.historico || '',
                        cnpj: olist.cnpj || '',
                    });
                    if (check.duplicado) {
                        duplicatasEncontradas.push({ par, matches: check.matches, motivo: check.motivo });
                    }
                }

                if (duplicatasEncontradas.length > 0) {
                    // Exibe alerta com todas as duplicatas encontradas
                    const todosMatches = duplicatasEncontradas.flatMap(d => d.matches.map(m => ({ ...m, olist_ref: d.par.lancamento_olist })));
                    document.getElementById('btn-confirmar-alta').disabled = false;
                    document.getElementById('btn-confirmar-alta').innerHTML = '✅ Confirmar Alta Confiança';

                    showModalDuplicidade(
                        todosMatches,
                        `${duplicatasEncontradas.length} de ${altaPares.length} itens têm possível duplicata`,
                        async () => {
                            // Usuário escolheu prosseguir mesmo assim
                            await _enviarLoteConfirmacao(altaPares);
                        }
                    );
                    return;
                }

                // ── Sem duplicatas: confirma lote diretamente ─────────────────
                await _enviarLoteConfirmacao(altaPares);

            } catch (e) {
                showToast('Erro: ' + e.message, true);
            }

            document.getElementById('btn-confirmar-alta').disabled = false;
            document.getElementById('btn-confirmar-alta').innerHTML = '✅ Confirmar Alta Confiança';
        }

        /** Envia o lote de confirmações para a API (sem verificação de duplicidade). */
        async function _enviarLoteConfirmacao(pares) {
            document.getElementById('btn-confirmar-alta').disabled = true;
            document.getElementById('btn-confirmar-alta').innerHTML = '<span class="loading"></span> Confirmando...';
            const paresPayload = pares.map(p => ({
                transacaoBancoId: p.transacao_banco.id,
                lancamentoOlistId: p.lancamento_olist.id,
            }));
            const r = await fetch(`${API}/confirmar-cruzamento-lote`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pares: paresPayload })
            }).then(r => r.json());
            if (r.sucesso) {
                showToast(`✅ ${r.confirmados} cruzamentos confirmados!`);
                loadResumo();
                setTimeout(() => executarCruzamento(), 800);
            } else {
                throw new Error(r.erro);
            }
        }

        // Atualiza botão de confirmar selecionados via checkboxes
        function updateLoteBtn() {
            // Futuramente: botão de confirmar seleção manual
        }

        // Ver alternativas de um par (exibe toast informativo)
        function verAlternativas(idx) {
            const par = cruzamentoFiltrados[idx];
            if (!par || !par.alternativas || par.alternativas.length === 0) return;
            const info = par.alternativas.map(a =>
                `Score ${a.score}: ${(a.historico || '').substring(0, 40)} — R$ ${Math.abs(a.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`
            ).join('\n');
            alert(`Alternativas para este match:\n\n${info}`);
        }

        // ─── Helpers ───
        function bancoLabel(b) { return { olist: 'Olist Conta Digital', santander: 'Santander', cresol: 'Cresol', caixa: 'Caixa Econômica', mercado_pago: 'Mercado Pago' }[b] || b; }
        function bancoEmoji(b) { return { olist: '💜', santander: '🔴', cresol: '🟢', caixa: '🔵', mercado_pago: '💛' }[b] || '🏦'; }
        function bancoColor(b) { return { olist: 'rgba(139,92,246,.2)', santander: 'rgba(239,68,68,.2)', cresol: 'rgba(16,185,129,.2)', caixa: 'rgba(59,130,246,.2)', mercado_pago: 'rgba(245,158,11,.2)' }[b] || 'rgba(100,100,100,.2)'; }

        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => t.classList.remove('show'), 4000);
        }


    </script>
</body>

</html>