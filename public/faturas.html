<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faturas de CartÃ£o â€” Calisul</title>
    <link rel="stylesheet" href="/css/design-system.css">
    <script src="/js/theme-toggle.js"></script>
    <script src="/js/sidebar.js"></script>
    <script src="/js/notifications.js"></script>
    <style>
        /* â”€â”€â”€ Page-specific â”€â”€â”€ */
        .upload-modal .drop-zone {
            border: 2px dashed var(--border-default);
            border-radius: var(--radius-lg);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            background: var(--bg-input);
        }

        .upload-modal .drop-zone:hover,
        .upload-modal .drop-zone.dragover {
            border-color: var(--blue);
            background: rgba(56, 139, 253, 0.05);
        }

        .upload-modal .drop-zone .icon {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.6;
        }

        .upload-modal .drop-zone h3 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .upload-modal .drop-zone p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .upload-modal .drop-zone input {
            display: none;
        }

        .upload-modal .drop-zone.processing {
            pointer-events: none;
            opacity: 0.6;
        }

        /* Progress mini */
        .progress-mini {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-mini .bar {
            flex: 1;
            height: 4px;
            background: var(--border-muted);
            border-radius: 2px;
            overflow: hidden;
            min-width: 60px;
        }

        .progress-mini .bar .fill {
            height: 100%;
            background: var(--green);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* â”€â”€â”€ Status Badges â”€â”€â”€ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: var(--radius-pill);
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-badge.status-pending {
            background: var(--orange-light);
            color: var(--orange);
        }

        .status-badge.status-categorized {
            background: var(--green-light);
            color: var(--green);
        }

        .status-badge.status-sent {
            background: var(--blue-light);
            color: var(--blue);
        }

        .status-badge .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* â”€â”€â”€ Status Filter Chips â”€â”€â”€ */
        .status-filters {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .status-filter-chip {
            padding: 6px 14px;
            border-radius: var(--radius-pill);
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border-default);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .status-filter-chip:hover {
            border-color: var(--border-strong);
            color: var(--text-primary);
        }

        .status-filter-chip.active {
            background: var(--blue-light);
            border-color: var(--blue);
            color: var(--blue);
        }

        /* â”€â”€â”€ Period Popover (Olist style) â”€â”€â”€ */
        .filter-wrap {
            position: relative;
        }

        .period-popover {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            min-width: 340px;
            overflow: hidden;
        }

        .period-popover.active {
            display: block;
        }

        .period-popover-body {
            padding: 20px;
        }

        .period-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .period-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .period-chip {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid var(--border-default);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
            white-space: nowrap;
        }

        .period-chip:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .period-chip.active {
            border-color: var(--blue);
            color: var(--blue);
            background: rgba(56, 139, 253, 0.08);
        }

        .period-chip.clear-chip.active {
            border-color: var(--green);
            color: var(--green);
        }

        .date-nav-row {
            display: none;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .date-nav-row.visible {
            display: flex;
        }

        .date-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border-default);
            background: transparent;
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-family: inherit;
            flex-shrink: 0;
        }

        .date-nav-btn:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .date-nav-label {
            flex: 1;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .interval-fields {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
        }

        .interval-fields.visible {
            display: flex;
        }

        .interval-row {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            background: var(--bg-input);
            overflow: hidden;
        }

        .interval-row .interval-label {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg-card-alt);
            border-right: 1px solid var(--border-default);
            min-width: 40px;
            text-align: center;
        }

        .interval-row input[type="date"] {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            outline: none;
        }

        .interval-row .calendar-icon {
            padding: 8px 12px;
            color: var(--text-muted);
            font-size: 14px;
        }

        .period-popover-footer {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border-top: 1px solid var(--border-muted);
        }

        .period-popover-footer .btn-apply {
            padding: 8px 24px;
            border-radius: 20px;
            background: var(--blue);
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-family: inherit;
            transition: background var(--transition-fast);
        }

        .period-popover-footer .btn-apply:hover {
            background: var(--blue-hover);
        }

        .period-popover-footer .btn-cancel {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }

        .period-popover-footer .btn-cancel:hover {
            color: var(--text-primary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .empty-state p {
            font-size: 13px;
        }

        /* Upload result */
        .upload-result {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-card-alt);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-default);
        }

        .upload-result .result-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
        }

        .upload-result .result-row .label {
            color: var(--text-muted);
        }

        .upload-result .result-row .value {
            font-weight: 600;
        }

        /* â”€â”€â”€ Selection Action Bar â”€â”€â”€ */
        .selection-bar {
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 10px 20px;
            z-index: 1500;
            align-items: center;
            gap: 16px;
            animation: slideUp 0.2s ease;
        }

        .selection-bar.visible {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .selection-bar .sel-count {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .selection-bar .sel-count strong {
            color: var(--blue);
        }

        .selection-bar .btn-send-olist {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--blue);
            background: rgba(0, 94, 252, 0.1);
            color: var(--blue);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .selection-bar .btn-send-olist:hover:not(:disabled) {
            background: rgba(0, 94, 252, 0.2);
        }

        .selection-bar .btn-send-olist:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .selection-bar .btn-delete-sel {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--red);
            background: rgba(248, 81, 73, 0.1);
            color: var(--red);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .selection-bar .btn-delete-sel:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        .selection-bar .btn-clear-sel {
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border-default);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: inherit;
        }

        .selection-bar .btn-clear-sel:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .modal-desc {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }
    </style>
</head>

<body>
    <div class="erp-layout">
        <!-- Sidebar injected by sidebar.js -->

        <!-- Main -->
        <main class="erp-main">
            <!-- Mobile toggle -->
            <button class="mobile-toggle" id="mobileToggle" aria-label="Menu">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12" />
                    <line x1="3" y1="6" x2="21" y2="6" />
                    <line x1="3" y1="18" x2="21" y2="18" />
                </svg>
            </button>

            <!-- Breadcrumb -->
            <div class="erp-breadcrumb">
                <a href="/">inicio</a>
                <span class="sep">/</span>
                <span>cartÃµes</span>
                <span class="sep">/</span>
                <span class="current">faturas</span>
            </div>

            <div class="erp-content">
                <!-- Page Header -->
                <div class="page-header">
                    <h1>Faturas de CartÃ£o</h1>
                    <div class="page-header-actions">
                        <button class="btn btn-blue" id="btnImportar" onclick="openUploadModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                                <polyline points="17 8 12 3 7 8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                            Importar Fatura
                        </button>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="filter-search">
                        <span class="search-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8" />
                                <line x1="21" y1="21" x2="16.65" y2="16.65" />
                            </svg></span>
                        <input type="text" id="searchInput" placeholder="Pesquisar por nome..."
                            oninput="applyFilters()">
                    </div>
                    <div class="filter-chips">
                        <div class="filter-wrap">
                            <button class="filter-chip active" id="btnPeriod" onclick="togglePeriodPopover()">
                                <span class="chip-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                                        <line x1="16" y1="2" x2="16" y2="6" />
                                        <line x1="8" y1="2" x2="8" y2="6" />
                                        <line x1="3" y1="10" x2="21" y2="10" />
                                    </svg></span> por perÃ­odo
                            </button>
                            <div class="period-popover" id="periodPopover">
                                <div class="period-popover-body">
                                    <div class="period-label">PerÃ­odo</div>
                                    <div class="period-chips">
                                        <button class="period-chip" data-period="30d"
                                            onclick="selectPeriod('30d')">Ãºltimos 30 dias</button>
                                        <button class="period-chip clear-chip active" data-period="none"
                                            onclick="selectPeriod('none')">sem filtro</button>
                                        <button class="period-chip" data-period="day" onclick="selectPeriod('day')">do
                                            dia</button>
                                        <button class="period-chip" data-period="week" onclick="selectPeriod('week')">da
                                            semana</button>
                                        <button class="period-chip" data-period="month"
                                            onclick="selectPeriod('month')">do mÃªs</button>
                                        <button class="period-chip" data-period="interval"
                                            onclick="selectPeriod('interval')">intervalo</button>
                                    </div>
                                    <div class="date-nav-row" id="dateNavRow">
                                        <button class="date-nav-btn" onclick="navigateDate(-1)">â€¹</button>
                                        <span class="date-nav-label" id="dateNavLabel">â€”</span>
                                        <button class="date-nav-btn" onclick="navigateDate(1)">â€º</button>
                                    </div>
                                    <div class="interval-fields" id="intervalFields">
                                        <div class="interval-row">
                                            <span class="interval-label">De</span>
                                            <input type="date" id="dateFrom" title="Data inicial">
                                        </div>
                                        <div class="interval-row">
                                            <span class="interval-label">AtÃ©</span>
                                            <input type="date" id="dateTo" title="Data final">
                                        </div>
                                    </div>
                                </div>
                                <div class="period-popover-footer">
                                    <button class="btn-apply" onclick="applyPeriodFilter()">aplicar</button>
                                    <button class="btn-cancel" onclick="cancelPeriodFilter()">cancelar</button>
                                </div>
                            </div>
                        </div>
                        <div id="cardChips" class="filter-chips"></div>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="status-filters">
                    <button class="status-filter-chip active" data-status="all"
                        onclick="filterByStatus('all')">Todas</button>
                    <button class="status-filter-chip" data-status="pending" onclick="filterByStatus('pending')">ðŸŸ¡
                        Pendentes</button>
                    <button class="status-filter-chip" data-status="categorized"
                        onclick="filterByStatus('categorized')">ðŸŸ¢ Categorizadas</button>
                    <button class="status-filter-chip" data-status="sent" onclick="filterByStatus('sent')">ðŸ”µ
                        Enviadas</button>
                </div>

                <!-- Table -->
                <div class="olist-table-wrapper" id="tableWrapper">
                    <table class="olist-table">
                        <thead>
                            <tr>
                                <th class="th-check"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th class="sortable" onclick="sortBy('statement_date')">
                                    Data <span class="sort-arrow" id="sort-statement_date">â‡…</span>
                                </th>
                                <th class="sortable" onclick="sortBy('filename')">
                                    Fatura <span class="sort-arrow" id="sort-filename">â‡…</span>
                                </th>
                                <th class="sortable" onclick="sortBy('financial_account')">
                                    Conta Financeira <span class="sort-arrow" id="sort-financial_account">â‡…</span>
                                </th>
                                <th>Progresso</th>
                                <th class="sortable" onclick="sortBy('status')">
                                    Status <span class="sort-arrow" id="sort-status">â‡…</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination hidden" id="pagination">
                    <span id="paginationInfo"></span>
                    <div class="pagination-pages" id="paginationPages"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Upload Modal -->
    <div class="modal-overlay upload-modal" id="uploadModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Importar fatura de cartÃ£o</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeUploadModal()" aria-label="Fechar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="drop-zone" id="dropZone">
                    <div class="upload-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg></div>
                    <h3>Arraste os PDFs das faturas aqui</h3>
                    <p>ou clique para selecionar (vÃ¡rios arquivos)</p>
                    <input type="file" id="fileInput" accept=".pdf" multiple>
                </div>
                <div id="uploadResult" class="hidden"></div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Confirmar exclusÃ£o</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeDeleteModal()" aria-label="Fechar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-desc">
                    Tem certeza que deseja excluir a fatura <strong id="deleteFilename"></strong>?
                    <br><br>
                    Todas as transaÃ§Ãµes dessa fatura serÃ£o removidas permanentemente.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline btn-sm" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn btn-danger btn-sm" id="btnConfirmDelete" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>

    <div class="selection-bar" id="selectionBar">
        <span class="sel-count" id="selCount"><strong>0</strong> selecionados</span>
        <button class="btn-send-olist" id="btnBatchOlist" onclick="batchSendToOlist()" disabled>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg>
            Enviar ao Olist
        </button>
        <button class="btn-delete-sel" onclick="deleteSelected()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
            </svg>
            Excluir selecionados
        </button>
        <button class="btn-clear-sel" onclick="clearSelection()">Limpar</button>
    </div>

    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let allStatements = [];
        let filteredStatements = [];
        let selectedIds = new Set();
        let currentSort = { field: 'statement_date', dir: 'desc' };
        let activeCardFilter = null;
        let activeStatusFilter = 'all';
        let dateFromFilter = null;
        let dateToFilter = null;
        let deleteTargetId = null;

        const PAGE_SIZE = 25;
        let currentPage = 1;

        // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            dateFromFilter = null;
            dateToFilter = null;
            loadStatements();
            loadCardChips();
            setupDropZone();
        });

        // â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadStatements() {
            try {
                const res = await fetch('/api/card-statements');
                const data = await res.json();
                allStatements = (data.statements || []).map(s => {
                    // Compute status based on categorization
                    const total = s.total_transactions || 0;
                    const categorized = s.categorized_count || 0;
                    let status = 'pending';
                    if (total > 0 && categorized >= total) {
                        status = 'categorized';
                    }
                    // If sent_to_olist flag exists, override
                    if (s.sent_to_olist) {
                        status = 'sent';
                    }
                    return { ...s, status };
                });
                applyFilters();
            } catch (e) {
                console.error('Erro ao carregar faturas:', e);
                showToast('Erro ao carregar faturas', 'error');
            }
        }

        async function loadCardChips() {
            try {
                const res = await fetch('/api/card-statements/cards');
                const data = await res.json();
                renderCardChips(data.cards || []);
            } catch (e) {
                console.error('Erro ao carregar cartÃµes:', e);
            }
        }

        // â”€â”€â”€ Status Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function filterByStatus(status) {
            activeStatusFilter = status;
            document.querySelectorAll('.status-filter-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.status === status);
            });
            applyFilters();
        }

        // â”€â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();

            filteredStatements = allStatements.filter(s => {
                if (search && !s.filename.toLowerCase().includes(search)) return false;
                if (activeCardFilter && s.card_name !== activeCardFilter) return false;
                if (dateFromFilter && s.statement_date < dateFromFilter) return false;
                if (dateToFilter && s.statement_date > dateToFilter) return false;
                if (activeStatusFilter !== 'all' && s.status !== activeStatusFilter) return false;
                return true;
            });

            // Sort
            filteredStatements.sort((a, b) => {
                let va = a[currentSort.field] || '';
                let vb = b[currentSort.field] || '';

                if (currentSort.field === 'categorized') {
                    va = a.total_transactions > 0 ? (a.categorized_count || 0) / a.total_transactions : 0;
                    vb = b.total_transactions > 0 ? (b.categorized_count || 0) / b.total_transactions : 0;
                }

                if (currentSort.field === 'status') {
                    const order = { pending: 0, categorized: 1, sent: 2 };
                    va = order[va] ?? 0;
                    vb = order[vb] ?? 0;
                }

                if (typeof va === 'string') va = va.toLowerCase();
                if (typeof vb === 'string') vb = vb.toLowerCase();

                if (va < vb) return currentSort.dir === 'asc' ? -1 : 1;
                if (va > vb) return currentSort.dir === 'asc' ? 1 : -1;
                return 0;
            });

            currentPage = 1;
            renderTable();
        }

        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.dir = field === 'statement_date' ? 'desc' : 'asc';
            }

            // Update arrows
            document.querySelectorAll('.sort-arrow').forEach(el => {
                el.textContent = 'â‡…';
                el.parentElement.classList.remove('sort-active');
            });
            const arrow = document.getElementById(`sort-${field}`);
            if (arrow) {
                arrow.textContent = currentSort.dir === 'asc' ? 'â†‘' : 'â†“';
                arrow.parentElement.classList.add('sort-active');
            }

            applyFilters();
        }

        // â”€â”€â”€ Card Chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderCardChips(cards) {
            const container = document.getElementById('cardChips');
            container.innerHTML = cards.map(card => `
                <button class="card-chip ${activeCardFilter === card ? 'active' : ''}" 
                        onclick="toggleCardFilter('${card}')">
                    ${card}
                </button>
            `).join('');
        }

        function toggleCardFilter(card) {
            activeCardFilter = activeCardFilter === card ? null : card;
            loadCardChips();
            applyFilters();
        }

        // â”€â”€â”€ Period Filter (Olist style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let activePeriod = 'none';
        let navDate = new Date();

        function togglePeriodPopover() {
            const popover = document.getElementById('periodPopover');
            popover.classList.toggle('active');
        }

        function selectPeriod(period) {
            activePeriod = period;

            document.querySelectorAll('.period-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.period === period);
            });

            const navRow = document.getElementById('dateNavRow');
            const intervalFields = document.getElementById('intervalFields');

            if (['day', 'week', 'month'].includes(period)) {
                navDate = new Date();
                navRow.classList.add('visible');
                intervalFields.classList.remove('visible');
                updateDateNavLabel();
            } else if (period === 'interval') {
                navRow.classList.remove('visible');
                intervalFields.classList.add('visible');
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                document.getElementById('dateFrom').value = formatISODate(weekAgo);
                document.getElementById('dateTo').value = formatISODate(today);
            } else {
                navRow.classList.remove('visible');
                intervalFields.classList.remove('visible');
            }
        }

        function navigateDate(direction) {
            if (activePeriod === 'day') {
                navDate.setDate(navDate.getDate() + direction);
            } else if (activePeriod === 'week') {
                navDate.setDate(navDate.getDate() + (direction * 7));
            } else if (activePeriod === 'month') {
                navDate.setMonth(navDate.getMonth() + direction);
            }
            updateDateNavLabel();
        }

        function updateDateNavLabel() {
            const label = document.getElementById('dateNavLabel');
            if (activePeriod === 'day') {
                label.textContent = formatDateBR(navDate);
            } else if (activePeriod === 'week') {
                const start = new Date(navDate);
                start.setDate(start.getDate() - start.getDay());
                const end = new Date(start);
                end.setDate(end.getDate() + 6);
                label.textContent = `${formatDateBR(start)} â€” ${formatDateBR(end)}`;
            } else if (activePeriod === 'month') {
                const months = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                label.textContent = `${months[navDate.getMonth()]} ${navDate.getFullYear()}`;
            }
        }

        function applyPeriodFilter() {
            const now = new Date();

            if (activePeriod === 'none') {
                dateFromFilter = null;
                dateToFilter = null;
            } else if (activePeriod === '30d') {
                const d = new Date(now);
                d.setDate(d.getDate() - 30);
                dateFromFilter = formatISODate(d);
                dateToFilter = null;
            } else if (activePeriod === 'day') {
                dateFromFilter = formatISODate(navDate);
                dateToFilter = formatISODate(navDate);
            } else if (activePeriod === 'week') {
                const start = new Date(navDate);
                start.setDate(start.getDate() - start.getDay());
                const end = new Date(start);
                end.setDate(end.getDate() + 6);
                dateFromFilter = formatISODate(start);
                dateToFilter = formatISODate(end);
            } else if (activePeriod === 'month') {
                const start = new Date(navDate.getFullYear(), navDate.getMonth(), 1);
                const end = new Date(navDate.getFullYear(), navDate.getMonth() + 1, 0);
                dateFromFilter = formatISODate(start);
                dateToFilter = formatISODate(end);
            } else if (activePeriod === 'interval') {
                dateFromFilter = document.getElementById('dateFrom').value || null;
                dateToFilter = document.getElementById('dateTo').value || null;
            }

            // Update chip label
            const btn = document.getElementById('btnPeriod');
            if (activePeriod === 'none') {
                btn.innerHTML = '<span class="chip-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span> por perÃ­odo';
                btn.classList.remove('active');
            } else {
                const periodLabels = { '30d': 'Ãºltimos 30 dias', 'day': 'do dia', 'week': 'da semana', 'month': 'do mÃªs', 'interval': 'intervalo' };
                const label = periodLabels[activePeriod] || 'por perÃ­odo';
                btn.innerHTML = `<span class="chip-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span> ${label}`;
                btn.classList.add('active');
            }

            document.getElementById('periodPopover').classList.remove('active');
            applyFilters();
        }

        function cancelPeriodFilter() {
            document.getElementById('periodPopover').classList.remove('active');
        }

        // Close popover on outside click
        document.addEventListener('click', (e) => {
            const popover = document.getElementById('periodPopover');
            const btn = document.getElementById('btnPeriod');
            if (popover && !popover.contains(e.target) && !btn.contains(e.target)) {
                popover.classList.remove('active');
            }
        });

        // â”€â”€â”€ Table Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getStatusBadge(status) {
            const configs = {
                pending: { label: 'Pendente', cls: 'status-pending' },
                categorized: { label: 'Categorizada', cls: 'status-categorized' },
                sent: { label: 'Enviada', cls: 'status-sent' },
            };
            const cfg = configs[status] || configs.pending;
            return `<span class="status-badge ${cfg.cls}"><span class="status-dot"></span>${cfg.label}</span>`;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');

            if (filteredStatements.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 0; border: none;">
                            <div class="empty-state">
                                <div class="empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
                                <h3>Nenhuma fatura encontrada</h3>
                                <p>Importe uma fatura de cartÃ£o usando o botÃ£o acima</p>
                            </div>
                        </td>
                    </tr>
                `;
                document.getElementById('pagination').classList.add('hidden');
                return;
            }

            // Paginate
            const start = (currentPage - 1) * PAGE_SIZE;
            const page = filteredStatements.slice(start, start + PAGE_SIZE);

            tbody.innerHTML = page.map(s => {
                const date = formatDate(s.statement_date);
                const total = s.total_transactions || 0;
                const categorized = s.categorized_count || 0;
                const pct = total > 0 ? Math.round((categorized / total) * 100) : 0;
                const checked = selectedIds.has(s.id) ? 'checked' : '';

                return `
                    <tr class="clickable" data-id="${s.id}">
                        <td class="td-check" onclick="event.stopPropagation()">
                            <input type="checkbox" ${checked} onchange="toggleSelect(${s.id}, this.checked)">
                        </td>
                        <td>${date}</td>
                        <td>${escapeHtml(s.filename)}</td>
                        <td>${escapeHtml(s.financial_account || 'â€”')}</td>
                        <td>
                            <div class="progress-mini">
                                <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
                                <span style="font-size:12px;color:var(--text-secondary)">${categorized}/${total}</span>
                            </div>
                        </td>
                        <td>${getStatusBadge(s.status)}</td>
                    </tr>
                `;
            }).join('');

            // Click handler for rows
            tbody.querySelectorAll('tr.clickable').forEach(tr => {
                tr.addEventListener('click', () => {
                    const id = tr.dataset.id;
                    window.location.href = `/extrato-detalhe.html?id=${id}`;
                });
            });

            renderPagination();
        }

        // â”€â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderPagination() {
            const total = filteredStatements.length;
            const totalPages = Math.ceil(total / PAGE_SIZE);
            const pag = document.getElementById('pagination');

            if (totalPages <= 1) {
                pag.classList.add('hidden');
                return;
            }

            pag.classList.remove('hidden');
            document.getElementById('paginationInfo').textContent =
                `${(currentPage - 1) * PAGE_SIZE + 1}â€“${Math.min(currentPage * PAGE_SIZE, total)} de ${total}`;

            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            document.getElementById('paginationPages').innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        // â”€â”€â”€ Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toggleSelect(id, checked) {
            if (checked) selectedIds.add(id);
            else selectedIds.delete(id);
            updateSelectionBar();
        }

        function toggleSelectAll() {
            const checkAll = document.getElementById('selectAll');
            const start = (currentPage - 1) * PAGE_SIZE;
            const pageItems = filteredStatements.slice(start, start + PAGE_SIZE);

            if (checkAll.checked) {
                pageItems.forEach(s => selectedIds.add(s.id));
            } else {
                pageItems.forEach(s => selectedIds.delete(s.id));
            }
            renderTable();
            updateSelectionBar();
        }

        function updateSelectionBar() {
            const bar = document.getElementById('selectionBar');
            const count = selectedIds.size;
            if (count > 0) {
                bar.classList.add('visible');
                document.getElementById('selCount').innerHTML = `<strong>${count}</strong> selecionado${count > 1 ? 's' : ''}`;

                // Enable Olist button only if ALL selected are fully categorized
                const btnOlist = document.getElementById('btnBatchOlist');
                const allCategorized = [...selectedIds].every(id => {
                    const s = allStatements.find(st => st.id === id);
                    return s && s.total_transactions > 0 && (s.categorized_count || 0) >= s.total_transactions;
                });
                btnOlist.disabled = !allCategorized;
                btnOlist.title = allCategorized
                    ? 'Enviar faturas selecionadas ao Olist'
                    : 'Todas as faturas selecionadas precisam estar 100% categorizadas';
            } else {
                bar.classList.remove('visible');
            }
        }

        function clearSelection() {
            selectedIds.clear();
            renderTable();
            updateSelectionBar();
            document.getElementById('selectAll').checked = false;
        }

        function deleteSelected() {
            if (selectedIds.size === 0) return;
            deleteTargetId = '__batch__';
            document.getElementById('deleteFilename').textContent = `${selectedIds.size} fatura${selectedIds.size > 1 ? 's' : ''} selecionada${selectedIds.size > 1 ? 's' : ''}`;
            document.getElementById('deleteModal').classList.add('active');
        }

        // â”€â”€â”€ Upload Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
            document.getElementById('uploadResult').classList.add('hidden');
            document.getElementById('uploadResult').innerHTML = '';
            resetDropZone();
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
        }

        function resetDropZone() {
            const dz = document.getElementById('dropZone');
            dz.classList.remove('processing');
            dz.innerHTML = `
                <div class="upload-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                <h3>Arraste os PDFs das faturas aqui</h3>
                <p>ou clique para selecionar (vÃ¡rios arquivos)</p>
                <input type="file" id="fileInput" accept=".pdf" multiple>
            `;
            setupDropZone();
        }

        function setupDropZone() {
            const dz = document.getElementById('dropZone');
            if (!dz) return;

            if (!dz._listenersSet) {
                dz._listenersSet = true;

                dz.addEventListener('click', (e) => {
                    if (dz.classList.contains('processing')) return;
                    const fi = document.getElementById('fileInput');
                    if (fi) fi.click();
                });

                dz.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dz.classList.add('dragover');
                });

                dz.addEventListener('dragleave', () => {
                    dz.classList.remove('dragover');
                });

                dz.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dz.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        uploadFiles(e.dataTransfer.files);
                    }
                });

                dz.addEventListener('change', (e) => {
                    if (e.target.matches('#fileInput') && e.target.files.length > 0) {
                        uploadFiles(e.target.files);
                    }
                });
            }
        }

        async function uploadFiles(fileList) {
            const files = [...fileList].filter(f => f.name.toLowerCase().endsWith('.pdf'));
            if (files.length === 0) {
                showToast('Apenas arquivos PDF sÃ£o aceitos', 'error');
                return;
            }

            const dz = document.getElementById('dropZone');
            const resultDiv = document.getElementById('uploadResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '';

            let successCount = 0;
            let errorCount = 0;
            const results = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Update drop zone with progress
                dz.classList.add('processing');
                dz.innerHTML = `
                    <div class="spinner"></div>
                    <h3>Processando ${i + 1} de ${files.length}...</h3>
                    <p>${file.name}</p>
                `;

                const formData = new FormData();
                formData.append('pdf', file);

                try {
                    const res = await fetch('/api/card-statements/upload', {
                        method: 'POST',
                        body: formData,
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        throw new Error(data.erro || 'Erro no upload');
                    }

                    successCount++;
                    results.push({ file: file.name, ok: true, data });
                } catch (e) {
                    errorCount++;
                    results.push({ file: file.name, ok: false, error: e.message });
                }
            }

            // Final state
            const icon = errorCount === 0
                ? '<path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'
                : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>';

            dz.innerHTML = `
                <div class="upload-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">${icon}</svg></div>
                <h3>${successCount} fatura${successCount !== 1 ? 's' : ''} importada${successCount !== 1 ? 's' : ''}${errorCount > 0 ? `, ${errorCount} erro${errorCount !== 1 ? 's' : ''}` : ''}</h3>
            `;

            // Show detailed results
            resultDiv.innerHTML = results.map(r => {
                if (r.ok) {
                    return `
                        <div class="upload-result">
                            <div class="result-row"><span class="label">âœ… ${escapeHtml(r.file)}</span></div>
                            <div class="result-row">
                                <span class="label">CartÃ£o</span>
                                <span class="value">${escapeHtml(r.data.card_name)}</span>
                            </div>
                            <div class="result-row">
                                <span class="label">TransaÃ§Ãµes</span>
                                <span class="value">${r.data.total_transactions} â€” R$ ${r.data.total_amount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="upload-result" style="border-color: var(--red);">
                            <div class="result-row"><span class="label">âŒ ${escapeHtml(r.file)}</span></div>
                            <div class="result-row"><span class="value" style="color: var(--red);">${escapeHtml(r.error)}</span></div>
                        </div>
                    `;
                }
            }).join('');

            if (successCount > 0) {
                showToast(`${successCount} fatura${successCount !== 1 ? 's' : ''} importada${successCount !== 1 ? 's' : ''}`);
                loadStatements();
                loadCardChips();
            }
        }

        // â”€â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openDeleteModal(id, filename) {
            deleteTargetId = id;
            document.getElementById('deleteFilename').textContent = filename;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            deleteTargetId = null;
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            if (!deleteTargetId) return;

            try {
                if (deleteTargetId === '__batch__') {
                    const ids = [...selectedIds];
                    let deleted = 0;
                    for (const id of ids) {
                        const res = await fetch(`/api/card-statements/${id}`, { method: 'DELETE' });
                        if (res.ok) deleted++;
                    }
                    selectedIds.clear();
                    updateSelectionBar();
                    document.getElementById('selectAll').checked = false;
                    showToast(`${deleted} fatura${deleted > 1 ? 's' : ''} excluÃ­da${deleted > 1 ? 's' : ''}`);
                } else {
                    const res = await fetch(`/api/card-statements/${deleteTargetId}`, { method: 'DELETE' });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.erro);
                    showToast('Fatura excluÃ­da');
                }

                closeDeleteModal();
                loadStatements();
            } catch (e) {
                showToast(e.message, 'error');
            }
        }

        // â”€â”€â”€ Batch Send to Olist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function batchSendToOlist() {
            const ids = [...selectedIds];
            if (ids.length === 0) return;

            // Validate all are categorized
            const uncategorized = ids.filter(id => {
                const s = allStatements.find(st => st.id === id);
                return !s || s.total_transactions === 0 || (s.categorized_count || 0) < s.total_transactions;
            });

            if (uncategorized.length > 0) {
                showToast('Todas as faturas precisam estar 100% categorizadas antes do envio', 'error');
                return;
            }

            let sent = 0;
            let errors = 0;

            for (const id of ids) {
                try {
                    const res = await fetch(`/api/card-statements/${id}/send-to-olist`, { method: 'POST' });
                    if (res.ok) {
                        sent++;
                    } else {
                        errors++;
                    }
                } catch (e) {
                    errors++;
                }
            }

            if (sent > 0) {
                showToast(`${sent} fatura${sent > 1 ? 's' : ''} enviada${sent > 1 ? 's' : ''} ao Olist`);
            }
            if (errors > 0) {
                showToast(`${errors} fatura${errors > 1 ? 's' : ''} com erro no envio`, 'error');
            }

            selectedIds.clear();
            updateSelectionBar();
            document.getElementById('selectAll').checked = false;
            loadStatements();
        }

        // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function formatDate(dateStr) {
            if (!dateStr) return 'â€”';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateStr;
        }

        function formatISODate(d) {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateBR(d) {
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>

</html>